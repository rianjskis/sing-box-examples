name: Build sing-box Linux ARM64 (PureGo)  
  
on:  
  workflow_dispatch:  
    inputs:  
      version:  
        description: "Version name"  
        required: true  
        default: "latest"  
  push:  
    branches:  
      - main  
      - main-next  
  
jobs:  
  calculate_version:  
    name: Calculate version  
    runs-on: ubuntu-latest  
    outputs:  
      version: ${{ steps.outputs.outputs.version }}  
    steps:  
      - name: Checkout  
        uses: actions/checkout@v5  
        with:  
          repository: SagerNet/sing-box  
          fetch-depth: 0  
      - name: Setup Go  
        uses: actions/setup-go@v5  
        with:  
          go-version: ^1.25.4  
      - name: Check input version  
        if: github.event_name == 'workflow_dispatch'  
        run: |-  
          echo "version=${{ inputs.version }}" >> "$GITHUB_ENV"  
      - name: Calculate version  
        if: github.event_name != 'workflow_dispatch'  
        run: |-  
          go run -v ./cmd/internal/read_tag --ci --nightly  
      - name: Set outputs  
        id: outputs  
        run: |-  
          echo "version=$version" >> "$GITHUB_OUTPUT"  
  
  build:  
    name: Build sing-box  
    runs-on: ubuntu-latest  
    needs: calculate_version  
    steps:  
      - name: Checkout sing-box  
        uses: actions/checkout@v5  
        with:  
          repository: SagerNet/sing-box  
          fetch-depth: 0  
        
      - name: Setup Go  
        uses: actions/setup-go@v5  
        with:  
          go-version: ^1.25.4  
        
      - name: Clone cronet-go  
        run: |  
          git clone --recursive --depth=1 https://github.com/sagernet/cronet-go.git ~/cronet-go  
        
      - name: Download libcronet.so for ARM64  
        run: |  
          cd ~/cronet-go  
          wget -O libcronet.so https://github.com/sagernet/cronet-go/releases/latest/download/libcronet-linux-arm64.so  
        
      - name: Set build tags  
        run: |  
          TAGS='with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale,with_ccm,badlinkname,tfogo_checklinkname0,with_naive_outbound,with_purego'  
          echo "BUILD_TAGS=${TAGS}" >> "${GITHUB_ENV}"  
        
      - name: Build sing-box  
        run: |  
          mkdir -p dist  
          go build -v -trimpath -o dist/sing-box -tags "${BUILD_TAGS}" \  
          -ldflags '-s -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ needs.calculate_version.outputs.version }} -checklinkname=0' \  
          ./cmd/sing-box  
        env:  
          CGO_ENABLED: "0"  
          GOOS: linux  
          GOARCH: arm64  
        
      - name: Prepare package  
        run: |  
          cd dist  
          mkdir -p sing-box-linux-arm64  
          cp sing-box sing-box-linux-arm64/  
          cp ~/cronet-go/libcronet.so sing-box-linux-arm64/  
          cp ../LICENSE sing-box-linux-arm64/  
          tar -czf sing-box-linux-arm64.tar.gz sing-box-linux-arm64/  
        
      - name: Upload artifact  
        uses: actions/upload-artifact@v4  
        with:  
          name: sing-box-linux-arm64  
          path: dist/sing-box-linux-arm64.tar.gz
